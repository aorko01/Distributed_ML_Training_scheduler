version: "3.9"

services:
  db:
    image: postgres:15
    container_name: app-db
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-admin}
      POSTGRES_DB: ${POSTGRES_DB:-app}
    ports:
      - "${DB_PORT:-5432}:5432"

  redis:
    image: redis:7
    container_name: app-redis
    restart: always
    ports:
      - "6379:6379"
    # Redis does not require environment variables by default
    # This service is needed so API can connect to host "redis"

  api:
    # Assuming you have a Dockerfile in the same directory.
    # The image can be built from that Dockerfile.
    build: .
    container_name: app-api
    depends_on:
      - db
      - redis
    # Start db and redis before starting api
    # Important note:
    # depends_on ensures startup order, NOT readiness
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      # DATABASE_URL format:
      # postgresql://<user>:<password>@<service_name>:<port>/<database_name>
      # - "db" matches the service name above
      DATABASE_URL: postgresql://${POSTGRES_USER:-admin}:${POSTGRES_PASSWORD:-admin}@db:5432/${POSTGRES_DB:-app}
      # Redis host/port for the API
      REDIS_HOST: redis
      REDIS_PORT: 6379